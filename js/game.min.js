/**
 * 'Spot the Flute' - a web game for Ten Out of Ten
 * made by Duncan Brown with graphics by Clare Dunn
 *
 * http://duncanjbrown.com
 *
 * "Yet left I not here, but committed a little more scutcherie"
 */
 
function pickRandomProperty(e){var t,n=0;for(var r in e)Math.random()<1/++n&&(t=r);return t}Array.prototype.shuffle=function(){var e=this.length,t,n,r;if(e==0)return!1;while(--e)t=Math.floor(Math.random()*(e+1)),n=this[e],r=this[t],this[e]=r,this[t]=n;return this},window.assetPath="assets/",window.levels={1:{speed:800,objects:1,rounds:10,hardItems:!1},2:{speed:760,objects:1,rounds:15,hardItems:!1},3:{speed:730,objects:1,rounds:20,hardItems:!1},4:{speed:700,objects:1,rounds:20,hardItems:!1},5:{speed:680,objects:2,rounds:20,hardItems:!1},6:{speed:660,objects:2,rounds:20,hardItems:!0},7:{speed:640,objects:3,rounds:20,hardItems:!0},8:{speed:620,objects:4,rounds:20,hardItems:!0},9:{speed:600,objects:5,rounds:20,hardItems:!0},10:{speed:500,objects:6,rounds:20,hardItems:!0}},window.items={1:{name:"biscuits"},2:{name:"teacup"},3:{name:"chair"},4:{name:"spanner"},5:{name:"guitar"},7:{name:"trumpet"},8:{name:"keyboard"},9:{name:"cinema"},10:{name:"beans"},11:{name:"brownie"},13:{name:"flowers"},14:{name:"popcorn"}},window.hardItems={15:{name:"clarinet"},6:{name:"oboe"},12:{name:"gokart"},12:{name:"gokart"}},window.ticketLink="/tickets",jQuery(document).ready(function(e){function d(e,t){var n;for(var r=0,i=e.length;r<i;++r)n=new Image,n.src=assetPath+t+"/"+e[r]}var t=function(t){this.interface=new f,this.numStages=t,this.stages=[],this.currentStage=0,this.stageCount=0;var n=this;e(this).on("interrupt",function(){if(n.currentStage){var e=n.currentStage.isWinner();n.stop(e),e?n.win_stage():n.lose_stage()}}),e(this).on("time-out",function(){n.stop(!1)}),e(document).keydown(function(t){return t.preventDefault(),t.which===32&&e(n).trigger("interrupt"),!1})};t.prototype.stop=function(e){this.interface.stop_playing(e),this.currentStage.stop(),this.currentStage=undefined},t.prototype.finishStage=function(){this.stageCount++},t.prototype.win_stage=function(){this.getReady()},t.prototype.missed=function(){this.stop(!1),this.interface.lose()},t.prototype.lose_stage=function(){this.stageCount<5?this.interface.loseEarly(this.stageCount-1):this.interface.loseLate(this.stageCount-1)},t.prototype.start=function(){this.currentStage.start()},t.prototype.getNextStage=function(){return this.stageCount++,this.stageCount<=this.numStages?new n(this.stageCount):!1},t.prototype.startPlay=function(){this.currentStage=this.getNextStage(),this.interface.startPlay(this.currentStage);var t=this;e("body").one("keydown",function(n){n.preventDefault();if(n.which===32)return e(this).unbind("keydown"),t.interface.refresh(),t.start(),!1})},t.prototype.getReady=function(){var t=this;this.stageCount<this.numStages?this.interface.getReady(this.stageCount+1):this.interface.win(),e(t).one("interrupt",function(e){return t.currentStage=t.getNextStage(),t.currentStage?(t.interface.refresh(),window.setTimeout(function(){t.start()},750)):(t.interface.refresh(),t.interface.showTwitterAndFacebook(stageCount)),!1})};var n=function(t){this.grid=e("#grid"),this.winner=!1,this.rounds=[],this.correctItem=u(),this.playing=!1,this.level=window.levels[t],this.getRoundsMarkup()};n.prototype.getRounds=function(){var e=[];for(var t=0;t<this.level.rounds-1;t++)e.push(new r(this.level.objects,this.level.hardItems));return e.push(new i(this.level.objects,this.level.hardItems,this.correctItem)),e.shuffle(),e},n.prototype.getRoundsMarkup=function(){_rounds=this.getRounds(),rounds=[];for(var t=0;t<_rounds.length;t++)(function(){if(!_rounds[t].layout)return;var n=e(".square").clone();for(var r=0;r<6;r++)(function(){_rounds[t].layout[r]!=undefined&&e(n[r]).addClass(_rounds[t].layout[r].name)})();rounds.push({squares:n,winner:_rounds[t]instanceof i,number:t})})();this.rounds=rounds},n.prototype.displayRound=function(e){this.grid.html(e.squares)},n.prototype.clearGrid=function(){e(".square").removeClass().addClass("square")},n.prototype.isWinner=function(){return this.winner},n.prototype.getNextRound=function(){var e=this.rounds.pop();return this.winner=e.winner,e},n.prototype.start=function(){this.playing&&clearInterval(this.playing);var t=this;this.rounds.length&&this.displayRound(this.getNextRound()),this.playing=setInterval(function(){if(t.winner==1){t.winner=!1,e(window.game).trigger("interrupt"),t.stop();return}if(!t.rounds.length){e(window.game).trigger("time-out"),t.stop();return}var n=t.getNextRound();t.displayRound(n)},t.level.speed)},n.prototype.stop=function(){this.clearGrid(),clearInterval(this.playing),this.winner=!1};var r=function(e,t){this.layout=new Array(6-e);for(var n=0;n<e;n++)this.layout.push(new o(t));this.layout.shuffle()},i=function(e,t,n){this.layout=new Array(6-e);for(var r=0;r<e-1;r++)this.layout.push(new o(t));this.layout.push(n),this.layout.shuffle()},s=function(){this.name=""},o=function(t){var n;n=t?e.extend({},window.items,window.hardItems):window.items;var r=pickRandomProperty(n);return n[r]},u=function(){return{name:"flute"}},a=function(t){this.message=t,this.messageApron=e(".messageApron"),this.element};a.prototype.display=function(t){this.element=e("<div>").removeClass().addClass("messageWindow "+t).html(this.message).appendTo(this.messageApron.show())},a.prototype.destroy=function(){this.messageApron.hide(),this.element&&this.element.remove()};var f=function(){this.man=new l,this.scoreBoard=new c;var e,t=this};f.prototype.getTwitterLink=function(e){return'<a target="_blank" href="http://twitter.com/?status=I scored '+e+" on Spot The Flute! - "+window.location+'"><img src="'+assetPath+'icons/twitter.png" /></a>'},f.prototype.getFacebookLink=function(e){return'<a target="_blank" href="http://facebook.com/sharer.php?u='+window.location+"&t=I+scored+"+e+'+on+Spot+The+Flute!"><img src="'+assetPath+'icons/facebook.png" /></a>'},f.prototype.startPlay=function(){messageWindow=new a(e("<img>").attr("src",assetPath+"text/intro.png")),messageWindow.display()},f.prototype.getReady=function(t){messageWindow=new a(e("<img>").attr("src",assetPath+"text/"+t+".png")),messageWindow.display()},f.prototype.loseEarly=function(t){var n=this;messageWindow=new a(e('<a href="'+window.location+'"><img src="'+assetPath+'text/ouch.png" /></a>')),messageWindow.display()},f.prototype.loseLate=function(t){messageWindow=new a(e('<a href="'+window.location+'"><img src="'+assetPath+'text/consolation.png" /></a>'+this.getFacebookLink(t)+this.getTwitterLink(t)+'<img src="'+assetPath+'text/showoff.png" />')),messageWindow.display("ending")},f.prototype.win=function(){messageWindow=new a(e('<a href="'+window.location+'"><img src="'+assetPath+'text/goldstar.png" /></a>'+this.getFacebookLink(score)+this.getTwitterLink(score)+'<img src="'+assetPath+'text/showoff.png" />')),messageWindow.display("ending")},f.prototype.stop_playing=function(e){e?(this.man.setState("HAPPY"),this.scoreBoard.addPoint()):this.man.setState("SAD")},f.prototype.refresh=function(){this.man.setState("NEUTRAL"),this.scoreBoard.showScore(),messageWindow.destroy()};var l=function(){var t={NEUTRAL:0,HAPPY:1,SAD:2},n=this,r;l.prototype.getState=function(){return t[r]},l.prototype.setState=function(n){r=n,e("#man").attr("src",window.assetPath+"man_"+t[n]+".png")},this.setState("NEUTRAL")},c=function(){function i(e){return r.attr("src",assetPath+"/numbers/"+e+".png")}var t=0,n=this,r=e("<img>").attr("src",assetPath+"numbers/0.png");this.element=e("#score"),c.prototype.addPoint=function(){t++,this.showScore()},c.prototype.showScore=function(){n.element.html(i(n.getScore()))},c.prototype.getScore=function(){return t}};e("body").one("keydown",function(n){window.game=new t(10),n.preventDefault();if(n.which===32)return e(this).unbind("keydown"),e("#press-space").hide(),window.game.startPlay(),!1});var h=["beans.png","biscuits.png","brownie.png","chair.png","cinema.png","clarinet.png","flowers.png","flute.png","gokart.png","guitar.png","keyboard.png","oboe.png","popcorn.png","spanner.png","teacup.png","trumpet.png"],p=["consolation.png","impressive.png","goldstar.png","1.png","2.png","3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png","intro.png","showoff.png"];d(h,"items"),d(p,"text")})